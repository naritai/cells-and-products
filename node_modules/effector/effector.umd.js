(function(t,e){'object'==typeof exports&&'undefined'!=typeof module?e(exports):'function'==typeof define&&define.amd?define(['exports'],e):e((t=t||self).effector={})})(this,function(t){function e(t,e){const r={};for(const o in e)r[o]=n.bind({key:o,group:t});return r}function n(t){return{id:P(),type:this.key,group:this.group,data:t}}function r(t){return{id:(++$).toString(36),current:t}}function o(t,e){if(t in M)return T.single(M[t](e));const n=t;for(var r=arguments.length,o=new Array(r>2?r-2:0),a=2;a<r;a++)o[a-2]=arguments[a];switch(n){case'single':return T.single(o[0]);case'multi':return T.multi(o);case'seq':return T.seq(o);case'choose':return T.choose(e);case'loop':return T.loop(e)}return'function'==typeof t?t(e,o):(console.error('unknown node "%s"',t),null)}function a(){const t=this.indexOf();-1!==t&&(this.splice(t,1),this.indexOf=D,this.splice=F)}function i(t,e,n){n.stop=0,H[t.type](t,e,n)}function s(t){try{t.result=t.fn.call(null,t.arg,t.val)}catch(e){console.error(e),t.err=1}return t}function c(t,e,n){this.shortName=t,this.fullName=e,this.path=n}function u(t,e){let n,r;const o=t;return void 0===e?(n=0===t.length?[]:[t],r=t):0===t.length?(n=e.path,r=e.fullName):(n=e.path.concat([t]),r=0===e.fullName.length?t:e.fullName+'/'+t),new c(o,r,n)}function l(t){let e=t.name,n=t.parent;const r=J(),a=e||r,s=function(t){const e=null==n?void 0:n.fullName;return e?e+'/'+t:t||''}(a),c=u(a,n),d=K({fullName:s}),p=function t(e){for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return t.create(e,s,r)};return p.getType=(()=>c.fullName),p.create=(t=>(function(t){(function(e){const n={transactions:[],stop:0,ctx:B.emit({__stepArg:t}),reg:{isChanged:1},val:{}};i(e,n.ctx,n);for(let t=0;t<n.transactions.length;t++)n.transactions[t]();n.transactions.length=0})(p.graphite.seq)}(t),t)),p.kind=A.event,p[O]=(()=>p),p.id=r,p.watch=function(t,e){return f({from:t,to:{graphite:{seq:o("run",{runner:n=>e(n,t.getType())})}}})}.bind(null,p),p.map=function(t,e){const n=l({name:t.shortName+' → *',parent:t.domainName});return f({from:t,to:{graphite:{seq:o("seq",null,o("compute",{fn:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(t=>e(t))}),n.graphite.seq)}}}),n}.bind(null,p),p.filter=function(t,e){const n=l({name:t.shortName+' →? *',parent:t.domainName});return f({from:t,to:{graphite:{seq:o("seq",null,o("compute",{fn:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(t=>e(t))}),o("filter",{filter:t=>void 0!==t}),n.graphite.seq)}}}),n}.bind(null,p),p.prepend=function(t,e){const n=l({name:'* → '+t.shortName,parent:t.domainName});return f({from:n,to:{graphite:{seq:o("seq",null,o("compute",{fn:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(t=>e(t))}),t.graphite.seq)}}}),n}.bind(null,p),p.subscribe=function(t,e){return t.watch(t=>e.next(t))}.bind(null,p),p.graphite=d,p.shortName=a,p.domainName=n,p.compositeName=c,p}function f(t){const e=t.to.graphite.seq,n=t.from.graphite;return n.next.data.push(e),z({child:e,parent:n})}function d(t){return l({name:t})}function p(t){return t.compositeName?t.compositeName.fullName:t.domainName?t.domainName.fullName:t.id}function m(t,e){const n=u(e,t.domainName);t.shortName=e,t.compositeName=n}function h(t){return t.plainState.current}function g(t,e){const n=t.subscribers.get(e);void 0!==n&&(n(),t.subscribers.delete(e))}function b(t,e,n){const r=e;return t.subscribers.set(r,f({from:r,to:{graphite:{seq:o("seq",null,o("compute",{fn:e=>{const o=h(t);return n(o,e,Q(r))}}),o("filter",{filter:e=>e!==h(t)&&void 0!==e}),t.graphite.seq)}}})),this}function v(t,e,n){switch(String((null==e?void 0:e.kind)||'__')){case'store':case'event':case'effect':return C('function'==typeof n,'watch requires function handler'),e.watch(r=>n(h(t),r,Q(e)));case'__':default:return C('function'==typeof e,'watch requires function handler'),y(t,e)}}function y(t,e){C('function'==typeof e,'Expected the listener to be a function');let n=h(t);try{e(n)}catch(t){console.error(t)}return f({from:t,to:{graphite:{seq:o("run",{runner:t=>{if(t!==n){n=t;try{e(t)}catch(t){console.error(t)}}}})}}})}function S(t){const e=t.currentState,n=t.name,a=t.parent,i=r(e),s=i.id,c=e,u=d('update '+s),l={graphite:R(i),kind:A.store,id:s,shortName:s,domainName:a,defaultState:c,plainState:i,subscribers:new Map};n&&m(l,n);const p={graphite:l.graphite,kind:A.store,id:s,shortName:s,domainName:a,setState:function(t,e){const n=('function'==typeof e?e:(t,e)=>e)(h(l),t);u(n)},off:g.bind(null,l),watch:v.bind(null,l),subscribe:y.bind(null,l),getState:h.bind(null,l)};return p.reset=function(t,e){return b.call(this,t,e,()=>t.defaultState)}.bind(p,l),p.on=b.bind(p,l),p.defaultState=c,p.map=function(t,e,n){let r,a=t.getState();try{r=e(a,n)}catch(t){console.error(t)}const i=this({name:t.shortName+' → *',currentState:r,parent:t.domainName});return f({from:t,to:{graphite:{seq:o("seq",null,o("compute",{fn:t=>{a=t;const n=i.getState();let r;try{r=e(t,n)}catch(t){console.error(t)}return r}}),o("filter",{filter:t=>{const e=t!==i.getState()&&void 0!==t;return e&&(r=t),e}}),i.graphite.seq)}}}),i}.bind(S,p),p.thru=function(t){return t(this)}.bind(p),p.dispatch=function(t){return t}.bind(null),p[O]=function(t){const e={subscribe:e=>(C('object'==typeof e&&null!==e,'Expected the observer to be an object.'),y(t,function(t){e.next&&e.next(t)}))};return e[O]=function(){return this},e}.bind(null,l),n&&m(p,n),p.on(u,(t,e)=>e),p}function N(t){return void 0!==t&&t!==this.current}function w(t){return S({currentState:t})}function q(t){return Array.isArray(t)?function(t){const e=[...t],n=[...t],r=d('update '+Math.random().toString());let a=[];const i=()=>(a=[],()=>{let t=c.getState();for(const e of a)t=e(t);s=i(),r(t)});let s=i();for(const t of e.map((t,e)=>[e,t])){const e=t[0],r=t[1];if(r.kind===A.store){const t=r,i=o("run",{runner:()=>{}});i.data.data.transactionContext=(t=>(a.push(n=>{const r=[...n];return r[e]=t,r}),s)),n[e]=t.getState(),f({from:t,to:{graphite:{seq:i}}})}}const c=S({name:function(t){let e=0;const n=L-1,r=t.length-1;let o='combine(';for(const a of t){const t=e===n||r===e?'':', ';if(o+=a.kind!==A.store?a.toString()+t:p(a)+t,e+=1,''===t)break}return o+')'}(t),currentState:n});return c.defaultShape=t,c.on(r,(t,e)=>e),c}(t):function(t){const e=Object.assign({},t),n=Object.assign({},t),r=d('update '+Math.random().toString());let a=[];const i=()=>(a=[],()=>{let t=c.getState();for(const e of a)t=e(t);s=i(),r(t)});let s=i();for(const t of Object.entries(e)){const e=t[0],r=t[1];if(r.kind!==A.store)continue;const i=o("run",{runner:()=>{}});i.data.data.transactionContext=(t=>(a.push(n=>Object.assign({},n,{[e]:t})),s)),n[e]=r.getState(),f({from:r,to:{graphite:{seq:i}}})}const c=S({name:function(t){let e=0;const n=Object.keys(t),r=L-1,o=n.length-1;let a='combine(';for(const n in t){const i=e===r||o===e?'':', ',s=t[n];if(a+=s.kind!==A.store?s.toString()+i:p(s)+i,e+=1,''===i)break}return a+')'}(t),currentState:n});return c.defaultShape=t,c.on(r,(t,e)=>e),c}(t)}function x(t){const e={};for(const n of Object.entries(t))e[n[0]]=w(n[1]);return e}function _(t,e){const n=w(e);return n.on(t.done,(t,e)=>e.result),n}function k(t,e){const n=w(e);return n.on(t,(t,e)=>e),n}function j(t){let e=t.parent,n=t.handler;const r=l({name:t.name,parent:e}),o=r.create,a=l({name:r.shortName+' done',parent:e}),i=l({name:r.shortName+' fail',parent:e});r.done=a,r.fail=i,r.use=(t=>(s=t,r)),r.use.getCurrent=(()=>s),r.kind=A.effect,r.create=((t,e,n)=>(o(t,r.getType(),n),W(t,Z(s,t=>void a(t),t=>void i(t)))));let s=n||function(){return V(0,'no thunk used in %s',this.getType()),Promise.resolve()}.bind(r);return r}var C=function(t){if(!t){var e=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");throw e.framesToPop=1,e}},O=function(){var t,e=('undefined'!=typeof self?self:'undefined'!=typeof window?window:'undefined'!=typeof global?global:'undefined'!=typeof module?module:Function("","return this")()).Symbol;return'function'==typeof e?e.observable?t=e.observable:(t=e('observable'),e.observable=t):t='@@observable',t}();const A={none:'none',store:'store',event:'event',effect:'effect'},E=()=>{let t=0;return()=>(++t).toString(36)},P=E(),T=e('step',{single:null,multi:null,seq:null,choose:null,loop:null}),M=e('cmd',{compute:null,emit:null,run:null,filter:null,update:null}),B=e('ctx',{compute:null,emit:null,run:null,filter:null,update:null});let $=0;const D=()=>-1,F=()=>[],z=t=>{const e=t.parent.next.data,n={indexOf:e.indexOf.bind(e,t.child),splice:e.splice.bind(e)},r=a.bind(n);return r.unsubscribe=a.bind(n),r},G={single(t,e,n){n.arg=e.data.__stepArg,n.ctx=I[t.data.type].cmd(t.data,n),n.stop=!I[n.ctx.type].transition(n.reg)},multi(t,e,n){const r=t.data.slice();for(let t=0;t<r.length;t++)i(r[t],e,n);n.stop=0},seq(t,e,n){n.ctx=e;const r=t.data.slice();for(let t=0;t<r.length&&(i(r[t],n.ctx,n),!n.stop);t++);}},H={};H.single=G.single,H.multi=G.multi,H.seq=G.seq;const I={emit:{cmd:(t,e)=>B.emit({__stepArg:e.arg}),transition:()=>1},filter:{cmd(t,e){const n=B.filter({__stepArg:e.arg}),r=s({err:0,result:null,arg:e.arg,val:e.val,fn:t.data.filter});return e.reg.isChanged=Boolean(r.result),n},transition:t=>Boolean(t.isChanged)},run:{cmd(t,e){const n=B.run({});return'transactionContext'in t.data&&e.transactions.push(t.data.transactionContext(e.arg)),s({err:0,result:null,arg:e.arg,val:e.val,fn:t.data.runner}),n},transition:()=>0},update:{cmd(t,e){let n;return(n='val'in t.data?e.val[t.data.val]=e.val[t.data.val]||r(null):t.data.store).current=e.arg,B.update({__stepArg:e.arg})},transition:()=>1},compute:{cmd(t,e){const n=B.compute({__stepArg:null}),r=s({err:0,result:null,arg:e.arg,val:e.val,fn:t.data.fn});return e.reg.isChanged=!r.err&&void 0!==r.result,r.err||(n.data.__stepArg=r.result),n},transition:t=>Boolean(t.isChanged)}},J=E(),K=t=>{const e=o("multi",null);return{next:e,seq:o("seq",null,o("emit",{fullName:t.fullName}),e)}},L=25,Q=('undefined'!=typeof performance&&'function'==typeof performance.mark&&'function'==typeof performance.clearMarks&&'function'==typeof performance.measure&&performance,t=>{switch(t.kind){case A.store:return t.shortName;default:return t.getType()}}),R=t=>{const e={};return e.next=o("multi",null),e.seq=o("seq",null,o("filter",{filter:N.bind(t)}),o("update",{store:t}),e.next),e},U={store:t=>t.obj,event:t=>k(t.obj,t.defaultState),effect:t=>_(t.obj,t.defaultState),__:t=>x(t.obj)};var V=function(){};const W=(t,e)=>{let n,r,o,a=0;try{r=e[2](t),a=1}catch(t){n=t}if(0==a){(o=Promise.reject(n)).cache=(()=>void 0);const r=Promise.resolve(void 0);return o.anyway=(()=>r),e[1]({params:t,error:n}),o}if('object'==typeof r&&null!==r&&'function'==typeof r.then){const n=(o=r.then(n=>(o.cache=(()=>n),e[0]({params:t,result:n}),n),n=>{throw e[1]({params:t,error:n}),n})).then(()=>{},()=>{});return o.anyway=(()=>n),o}const i=r;(o=Promise.resolve(i)).cache=(()=>i);const s=Promise.resolve(void 0);return o.anyway=(()=>s),e[0]({params:t,result:i}),o},X=function(t){const e=this[3];this.length=0,e(t)},Y=function(t){const e=this[4];this.length=0,e(t)},Z=(t,e,n)=>[X,Y,t,e,n];class tt{constructor(){this.events=new Set,this.effects=new Set,this.storages=new Set,this.domains=new Set}}const et=E();t.combine=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];C(e.length>0,'at least one argument required');const r=e[e.length-1];return q(e.slice(0,-1)).map(t=>r(...t))},t.createDomain=function(t){return function t(e,n,r){const o=et(),a=u(e||'',n),i=new tt,s=function(t,e,n){let r;return(r=n?(t=>({event:t.event.prepend(t=>t),effect:t.effect.prepend(t=>t),store:t.store.prepend(t=>t),domain:t.domain.prepend(t=>t)}))(n):(t=>({event:l({name:`${t.fullName} event hook`,parent:t}),effect:l({name:`${t.fullName} effect hook`,parent:t}),store:l({name:`${t.fullName} store hook`,parent:t}),domain:l({parent:t})}))(e)).domain.watch(e=>{t.domains.add(e)}),r.event.watch(e=>{t.events.add(e)}),r.store.watch(e=>{t.storages.add(e)}),r.effect.watch(e=>{t.effects.add(e)}),r}(i,a,r);return{compositeName:a,id:o,getType:()=>a.fullName,onCreateEvent:t=>(i.events.forEach(t),s.event.watch(t)),onCreateEffect:t=>(i.effects.forEach(t),s.effect.watch(t)),onCreateStore:t=>(i.storages.forEach(t),s.store.watch(t)),onCreateDomain:t=>(i.domains.forEach(t),s.domain.watch(t)),event(t){const e=l({name:t,parent:a});return s.event(e),e},effect(t){const e=j({name:t,domainName:a.fullName,parent:a});return s.effect(e),e},domain(e){const n=t(e,a,s);return s.domain(n),n},store(t){const e=S({currentState:t,parent:a});return s.store(e),e}}}(void 0===t?'':t)},t.createEvent=d,t.forward=f,t.createEffect=function(t,e){const n={};return n.name=t,n.domainName='',n.handler=null==e?void 0:e.handler,j(n)},t.createStore=w,t.createStoreObject=q,t.setStoreName=m,t.extract=function(t,e){let n;return q(n=e('defaultShape'in t?t.defaultShape:t.defaultState))},t.createApi=function(t,e){const n={};for(const r of Object.entries(e)){const e=r[0],o=r[1],a=d(e);t.on(a,o),n[e]=a}return n},t.restore=function(t,e){return U[String((null==t?void 0:t.kind)||'__')]({obj:t,defaultState:e})},t.restoreEvent=k,t.restoreEffect=_,t.restoreObject=x,t.withProps=function(t,e){return n=>e(t.getState(),n)},Object.defineProperty(t,'__esModule',{value:1})});
//# sourceMappingURL=effector.umd.js.map
